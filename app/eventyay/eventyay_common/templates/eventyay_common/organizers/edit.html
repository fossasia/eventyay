{% extends "eventyay_common/base.html" %}
{% load i18n %}
{% load bootstrap3 %}

{% block title %}{% translate "Organizer settings" %}{% endblock %}

{% block content %}
<h1 class="page-header">{% translate "Teams" %}</h1>
<div class="organizer-management">
    {% if can_manage_teams %}
            <div class="mt-3">
                <div class="clearfix">
                    <h2 class="pull-left" style="margin: 0;">{{ organizer.name }} {% translate "Teams" %}</h2>
                    <button type="button" class="btn btn-primary pull-right" data-toggle="collapse" data-target="#create-team-form">
                        <i class="fa fa-plus"></i> {% translate "Create a team" %}
                    </button>
                </div>
                <p class="text-muted" style="clear: both; padding-top: 10px;">{% translate "Edit permissions for existing teams. Click 'Edit' to expand the permissions form." %}</p>

                <div id="create-team-form" class="collapse">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">{% translate "Create a new team" %}</h3>
                        </div>
                        <div class="panel-body">
                            <form action="" method="post" class="form-horizontal">
                                {% csrf_token %}
                                <input type="hidden" name="team_action" value="create">
                                {% bootstrap_form_errors team_create_form %}
                                {% include "eventyay_common/organizers/teams/_permissions_fieldsets.html" with form=team_create_form %}
                                <div class="form-group submit-group">
                                    <button type="submit" class="btn btn-primary">
                                        {% translate "Create team" %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                {% for panel in team_panels %}
                <div class="panel-group team-permissions-panel" id="team-accordion-{{ panel.team.pk }}">
                    <div class="panel panel-default mt-3">
                    <div class="panel-heading clearfix">
                        <div class="team-heading-main">
                            <h3 class="panel-title">{{ panel.team.name }}</h3>
                            <div class="text-muted team-meta">
                                <span class="team-meta-item">
                                    <i class="fa fa-user"></i>
                                    {% with memcount=panel.team.memcount %}
                                        {% blocktranslate trimmed count count=memcount %}
                                            {{ count }} member
                                        {% plural %}
                                            {{ count }} members
                                        {% endblocktranslate %}
                                    {% endwith %}
                                </span>
                                <span class="team-meta-sep">·</span>
                                <span class="team-meta-item">
                                    <i class="fa fa-calendar"></i>
                                    {% if panel.team.all_events %}
                                        {% translate "All events" %}
                                    {% else %}
                                        {% with eventcount=panel.team.eventcount %}
                                            {% blocktranslate trimmed count count=eventcount %}
                                                {{ count }} event
                                            {% plural %}
                                                {{ count }} events
                                            {% endblocktranslate %}
                                        {% endwith %}
                                    {% endif %}
                                </span>
                                {% if panel.team.invcount %}
                                    <span class="team-meta-sep">·</span>
                                    <span class="team-meta-item">
                                        <i class="fa fa-envelope"></i>
                                        {% with invcount=panel.team.invcount %}
                                            {% blocktranslate trimmed count count=invcount %}
                                                {{ count }} invite pending
                                            {% plural %}
                                                {{ count }} invites pending
                                            {% endblocktranslate %}
                                        {% endwith %}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="team-actions btn-toolbar pull-right">
                            <div class="btn-group btn-group-sm">
                                <button type="button"
                                        class="btn btn-primary btn-sm"
                                        data-toggle="collapse"
                                        data-target="#team-permissions-{{ panel.team.pk }}"
                                        aria-expanded="{% if panel.is_permissions_open %}true{% else %}false{% endif %}">
                                    <i class="fa fa-sliders"></i> {% translate "Team permissions" %}
                                </button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button"
                                        class="btn btn-default btn-sm"
                                        data-toggle="collapse"
                                        data-target="#team-members-{{ panel.team.pk }}"
                                        aria-expanded="{% if panel.is_members_open %}true{% else %}false{% endif %}">
                                    <i class="fa fa-users"></i> {% translate "Members & API" %}
                                </button>
                            </div>
                            <form action="" method="post"
                                  class="team-delete-form btn-group btn-group-sm"
                                  data-confirm="{% translate "Are you sure you want to delete this team?" %}">
                                {% csrf_token %}
                                <input type="hidden" name="team_action" value="delete">
                                <input type="hidden" name="team_id" value="{{ panel.team.pk }}">
                                <button type="submit" class="btn btn-danger btn-sm"
                                        {% if not panel.can_delete %}disabled{% endif %}>
                                    <i class="fa fa-trash"></i> {% translate "Delete" %}
                                </button>
                            </form>
                        </div>
                    </div>
                    <div id="team-permissions-{{ panel.team.pk }}"
                         class="panel-collapse collapse {% if panel.is_permissions_open %}in{% endif %}"
                         data-parent="#team-accordion-{{ panel.team.pk }}">
                        <div class="panel-body">
                            <form action="" method="post" class="team-permissions-form form-horizontal">
                                {% csrf_token %}
                                <input type="hidden" name="team_action" value="update">
                                <input type="hidden" name="team_id" value="{{ panel.team.pk }}">
                                {% bootstrap_form_errors panel.form %}
                                {% include "eventyay_common/organizers/teams/_permissions_fieldsets.html" with form=panel.form %}
                                <div class="form-group submit-group">
                                    <button type="submit" class="btn btn-primary">
                                        {% translate "Save permissions" %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div id="team-members-{{ panel.team.pk }}"
                         class="panel-collapse collapse {% if panel.is_members_open %}in{% endif %}"
                         data-parent="#team-accordion-{{ panel.team.pk }}">
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h4>{% translate "Members & invites" %}</h4>
                                    <form action="" method="post" class="team-members-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="team_action" value="members">
                                        <input type="hidden" name="team_id" value="{{ panel.team.pk }}">
                                        {% bootstrap_form_errors panel.invite_form %}
                                        <table class="table table-condensed table-hover">
                                            <thead>
                                                <tr>
                                                    <th>{% translate "Member" %}</th>
                                                    <th class="text-right flip" width="150"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for member in panel.members %}
                                                <tr>
                                                    <td>
                                                        {{ member.email }}
                                                        {% if member.require_2fa %}
                                                            <span class="fa fa-shield text-success" data-toggle="tooltip"
                                                                  title="{% translate "Two-factor authentication enabled" %}"></span>
                                                        {% else %}
                                                            <span class="fa fa-shield disabled" data-toggle="tooltip"
                                                                  title="{% translate "Two-factor authentication disabled" %}"></span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-right flip">
                                                        <button type="submit" name="remove-member" value="{{ member.id }}"
                                                                class="btn btn-delete btn-sm btn-block">
                                                            <i class="fa fa-times"></i> {% translate "Remove" %}
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="2" class="text-muted">
                                                        {% translate "No members yet." %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                {% for invite in panel.invites %}
                                                <tr>
                                                    <td>
                                                        {{ invite.email }}
                                                        <span class="fa fa-envelope-o" data-toggle="tooltip"
                                                              title="{% translate "invited, pending response" %}"></span>
                                                        <button type="submit" name="resend-invite" value="{{ invite.id }}"
                                                                data-toggle="tooltip" title="{% translate "Resend invite" %}"
                                                                class="btn-invisible">
                                                            <span class="fa fa-repeat"></span>
                                                        </button>
                                                    </td>
                                                    <td class="text-right flip">
                                                        <button type="submit" name="remove-invite" value="{{ invite.id }}"
                                                                class="btn btn-delete btn-sm btn-block">
                                                            <i class="fa fa-times"></i> {% translate "Remove" %}
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td>
                                                        {% bootstrap_field panel.invite_form.user layout='inline' %}
                                                        <small class="text-muted">
                                                            {% blocktrans trimmed %}
                                                                Enter an email address to add a user. Existing eventyay accounts
                                                                are added immediately; everyone else receives an invitation email.
                                                            {% endblocktrans %}
                                                        </small>
                                                    </td>
                                                    <td class="text-right flip">
                                                        <button type="submit" class="btn btn-primary btn-sm btn-block">
                                                            <i class="fa fa-plus"></i> {% translate "Add" %}
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <h4>{% translate "API tokens" %}</h4>
                                    <form action="" method="post" class="team-token-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="team_action" value="tokens">
                                        <input type="hidden" name="team_id" value="{{ panel.team.pk }}">
                                        {% bootstrap_form_errors panel.token_form %}
                                        <table class="table table-condensed table-hover">
                                            <thead>
                                                <tr>
                                                    <th>{% translate "Name" %}</th>
                                                    <th class="text-right flip" width="150"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for token in panel.tokens %}
                                                <tr>
                                                    <td>{{ token.name }}</td>
                                                    <td class="text-right flip">
                                                        <button type="submit" name="remove-token" value="{{ token.id }}"
                                                                class="btn btn-delete btn-sm btn-block">
                                                            <i class="fa fa-times"></i> {% translate "Remove" %}
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="2" class="text-muted">
                                                        {% translate "No tokens have been created yet." %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td>
                                                        {% bootstrap_field panel.token_form.name layout='inline' %}
                                                    </td>
                                                    <td class="text-right flip">
                                                        <button type="submit" class="btn btn-primary btn-sm btn-block">
                                                            <i class="fa fa-plus"></i> {% translate "Add" %}
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                {% empty %}
                <div class="alert alert-info">
                    {% translate "No teams exist yet. Click 'Create a team' to add your first team." %}
                </div>
                {% endfor %}
            </div>
    {% endif %}
</div>
{% endblock %}
