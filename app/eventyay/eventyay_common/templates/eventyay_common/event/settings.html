{% extends "eventyay_common/event/settings_base.html" %}
{% load i18n %}
{% load bootstrap3 %}
{% load static %}
{% load hierarkey_form %}
{% load formset_tags %}
{% block title %}{% trans "General settings" %}{% endblock %}
{% block custom_header %}
{{ block.super }}
<link type="text/css" rel="stylesheet" href='{% url "control:pdf.css" %}'>
<link type="text/css" rel="stylesheet" href='{% static "eventyay-common/css/partner.css" %}'>
{{ sform.media }}
{% endblock %}
{% block inside %}
<nav id="event-nav" class="header-nav">
    <div class="navigation">
        <div class="navigation-title">
            <h1>{{ request.event.name }} {% trans "- Settings" %}</h1>
        </div>
        <div class="navigation-button">
            <a href="#" class="header-nav btn btn-outline-success active">
                <i class="fa fa-home"></i> {% trans "Home" %}
            </a>
            <a href='{% url "control:event.index" organizer=request.organizer.slug event=request.event.slug %}'
                class="header-nav btn btn-outline-success">
                <i class="fa fa-ticket"></i> {% trans "Tickets" %}
            </a>
            {% if is_talk_event_created %}
            <a href='{% url "orga:event.dashboard" event=request.event.slug %}' class="header-nav btn btn-outline-success">
                <i class="fa fa-group"></i> {% trans "Talks" %}
            </a>
            {% endif %}
            {% if is_video_enabled %}
            <a class="header-nav btn btn-outline-success"
                href='{% url "eventyay_common:event.create_access_to_video" organizer=request.organizer.slug event=request.event.slug %}'
                title="{% trans 'Access videos related to this event' %}">
                <i class="fa fa-video-camera"></i> {% trans "Videos" %}
            </a>
            {% endif %}
        </div>
    </div>
</nav>
<form action="" method="post" class="form-horizontal" enctype="multipart/form-data">
    {% csrf_token %}
    {% bootstrap_form_errors form %}
    {% bootstrap_form_errors sform %} {# Added to show sform errors #}
    {% comment %} TODO: Reintroduce component selection when unified component initialization is stable. {% endcomment %}
    <div class="tabbed-form">
        <fieldset>
            <legend>{% trans "Basics" %}</legend>
            {% bootstrap_field form.name layout="control" %}
            {% bootstrap_field form.slug layout="control" %}
            {% if form.domain %} {# Conditionally show if domain field is added to form #}
            {% bootstrap_field form.domain layout="control" %}
            {% endif %}
            {% bootstrap_field form.date_from layout="control" %}
            {% bootstrap_field form.date_to layout="control" %}
            {% bootstrap_field form.date_admission layout="control" %}
            {% include "pretixcontrol/event/fragment_geodata.html" %}
            {% bootstrap_field form.email layout="control" %}
            {% bootstrap_field sform.imprint_url layout="control" %}
            <div class="form-group">
                <label class="col-md-3 control-label">
                    {% translate "Header links" %}
                </label>
                <div class="col-md-9">
                    <div class="help-block text-muted">
                        {% blocktranslate trimmed %}
                            These links will be shown at the top of all your schedule-related pages, e.g.
                            the schedule itself, speaker pages, session pages, etc.
                            You could for example link to your home page, your registration page, or your
                            livestream here.
                        {% endblocktranslate %}
                    </div>
                    {% include "orga/includes/event_links_formset.html" with formset=header_links_formset %}
                </div>
            </div>

            <div class="form-group">
                <label class="col-md-3 control-label">
                    {% translate "Footer links" %}
                </label>
                <div class="col-md-9">
                    <div class="help-block text-muted">
                        {% blocktranslate trimmed %}
                            These links will be shown in the footer of all your public pages. You could
                            for example link your terms of service, imprint, or privacy policy here.
                        {% endblocktranslate %}
                    </div>
                    {% include "orga/includes/event_links_formset.html" with formset=footer_links_formset %}
                </div>
            </div>
            {% bootstrap_field form.is_public layout="control" %}
            {% comment %}
            <div class="setting-part">
                <div class="form-group setting-form">
                    <label class="col-md-3 control-label">{% trans "Tickets system" %}</label>
                    <div class="col-md-9 col-value">
                        <button type="button" class="btn btn-sm btn-default enabled-btn" data-toggle="modal"
                            data-target="#alert-modal-disabled">
                            {% trans "Enabled" %}
                        </button>
                        <a href='{% url "control:event.index" organizer=request.organizer.slug event=request.event.slug %}'
                            class="btn btn-sm btn-default" title='{% trans "Dashboard" %}' data-toggle="tooltip">
                            <span class="fa fa-dashboard"></span>
                        </a>
                        <a href='{% url "control:event.settings" organizer=request.organizer.slug event=request.event.slug %}'
                            class="btn btn-sm btn-default" title='{% trans "Setting" %}' data-toggle="tooltip">
                            <span class="fa fa-edit"></span>
                        </a>
                    </div>
                </div>
                <div class="form-group setting-form">
                    <label class="col-md-3 control-label">{% trans "Talks system" %}</label>
                    <div class="col-md-9 col-value">
                        {% if is_talk_event_created %}
                        <button type="button" class="btn btn-sm btn-default enabled-btn" data-toggle="modal"
                            data-target="#alert-modal-disabled">
                            {% trans "Enabled" %}
                        </button>
                        <a href='{% url "orga:event.dashboard" event=request.event.slug %}' class="btn btn-sm btn-default"
                            title='{% trans "Dashboard" %}' data-toggle="tooltip">
                            <span class="fa fa-dashboard"></span>
                        </a>
                        <a href='{% url "orga:settings.event.view" event=request.event.slug %}' class="btn btn-sm btn-default"
                            title='{% trans "Settings" %}' data-toggle="tooltip">
                            <span class="fa fa-edit"></span>
                        </a>
                        {% else %}
                        <button type="button" class="btn btn-sm btn-default disabled-btn" data-toggle="modal"
                            data-target="#alert-modal-enable-talk">
                            {% trans "Disabled" %}
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="form-group custom-form">
                    <label class="col-md-3 control-label">{% trans "Video system" %}</label>
                    <div class="col-md-9 col-value">
                        {% if is_video_enabled %}
                        <button type="button" class="btn btn-sm btn-default enabled-btn" data-toggle="modal"
                            data-target="#alert-modal-disabled">
                            {% trans "Enabled" %}
                        </button>
                        <a href='{% url "eventyay_common:event.create_access_to_video" organizer=request.organizer.slug event=request.event.slug %}'
                            class="btn btn-sm btn-default" title='{% trans "Video Configuration" %}'
                            data-toggle="tooltip">
                            <span class="fa fa-edit"></span>
                        </a>
                        {% else %}
                        <button type="button" class="btn btn-sm btn-default disabled-btn" data-toggle="modal"
                            data-target="#alert-modal-enable-video">
                            {% trans "Disabled" %}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endcomment %}
        </fieldset>
        <fieldset>
            <legend>{% trans "Localization" %}</legend>
            {% bootstrap_field sform.locales layout="control" %}
            {% if sform.content_locales %}{% bootstrap_field sform.content_locales layout="control" %}{% endif %}
            {% bootstrap_field sform.locale layout="control" %}
            {% bootstrap_field sform.timezone layout="control" %}
            {% bootstrap_field sform.region layout="control" %}
        </fieldset>
        <fieldset>
            <legend>{{ _('Texts') }}</legend>
            {% bootstrap_field sform.frontpage_text layout="control" %}
        </fieldset>
        <fieldset id="partner-tab">
            <legend>{% trans "Partner" %}</legend>
            
            <div class="panel panel-default partner-section-panel">
                <div class="panel-heading partner-panel-heading">
                    <h3 class="panel-title partner-panel-title">
                        {% trans "Partner Section Heading" %}
                    </h3>
                </div>
                <div class="panel-body partner-panel-body">
                    <div class="form-group">
                        <label for="id_settings-partner_section_heading" class="partner-heading-label">
                            {% trans "Section heading" %}
                        </label>
                        <div class="partner-heading-input-wrapper">
                            {{ sform.partner_section_heading }}
                        </div>
                        <p class="help-block">{{ sform.partner_section_heading.help_text }}</p>
                    </div>
                </div>
            </div>
            
            <div class="panel panel-default">
                <div class="panel-heading partner-panel-heading">
                    <h3 class="panel-title partner-panel-title">
                        {% translate "Sponsor groups" %}
                    </h3>
                </div>
                <div class="panel-body partner-panel-body">
                    <p class="help-block partner-help-block">
                        {% blocktranslate trimmed %}
                            Create groups for different sponsor tiers (e.g., Platinum, Gold, Silver).
                            Each group can contain multiple partners with logos and links.
                        {% endblocktranslate %}
                    </p>
                    
                    {% if sponsor_groups %}
                    <div id="sponsor-groups-list" class="sponsor-groups-sortable sponsor-groups-list">
                        {% for group in sponsor_groups %}
                        <div class="sponsor-group-item panel panel-default" data-group-id="{{ group.id }}">
                            <div class="panel-heading sponsor-group-heading">
                                <div class="row">
                                    <div class="col-md-7">
                                        <span class="handle sponsor-group-handle" aria-label="{% trans 'Drag to reorder sponsor group' %}">
                                            <i class="fa fa-bars"></i>
                                        </span>
                                        <strong class="sponsor-group-title">{{ group.name }}</strong>
                                        <span class="label label-default sponsor-group-badge">
                                            {{ group.partners.count }} partner{{ group.partners.count|pluralize }}
                                        </span>
                                    </div>
                                    <div class="col-md-5 text-right">
                                        <a href="{% url 'eventyay_common:partner.manage' organizer=request.organizer.slug event=request.event.slug group_pk=group.id %}" 
                                           class="btn btn-sm btn-default">
                                            <i class="fa fa-users"></i> {% trans "Manage Partners" %}
                                        </a>
                                        <a href="{% url 'eventyay_common:partner.group.edit' organizer=request.organizer.slug event=request.event.slug pk=group.id %}" 
                                           class="btn btn-sm btn-default">
                                            <i class="fa fa-edit"></i>
                                        </a>
                                        <a href="{% url 'eventyay_common:partner.group.delete' organizer=request.organizer.slug event=request.event.slug pk=group.id %}" 
                                           class="btn btn-sm btn-danger">
                                            <i class="fa fa-trash"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% if group.partners.exists %}
                            <div class="panel-body sponsor-group-body">
                                <div class="partner-logos-preview partner-inline-sortable" data-group-id="{{ group.id }}">
                                    {% for partner in group.partners.all %}
                                        <div class="partner-item-inline" data-partner-id="{{ partner.id }}">
                                            <span class="partner-drag-handle" aria-label="{% trans 'Drag to reorder partner' %}">
                                                <i class="fa fa-bars"></i>
                                            </span>
                                            {% if partner.logo %}
                                            <img src="{{ partner.logo.url }}" alt="{{ partner.name }}" 
                                                 class="partner-logo-preview" 
                                                 title="{{ partner.name }}">
                                            {% else %}
                                            <span class="label label-info partner-name-label">{{ partner.name }}</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info partner-empty-state">
                        <i class="fa fa-info-circle"></i>
                        {% trans "No sponsor groups created yet. Add your first sponsor group to get started." %}
                    </div>
                    {% endif %}
                    
                    <a href="{% url 'eventyay_common:partner.group.add' organizer=request.organizer.slug event=request.event.slug %}" 
                       class="btn btn-default">
                        <i class="fa fa-plus"></i> {% trans "Add Sponsor Group" %}
                    </a>
                </div>
            </div>
        </fieldset>
        <fieldset>
            <legend>{{ _('Design') }}</legend>
            {% bootstrap_field sform.event_logo_image layout="control" %}
            {% bootstrap_field sform.logo_show_title layout="control" %}
            {% bootstrap_field sform.logo_image layout="control" %}
            {% bootstrap_field sform.logo_image_large layout="control" %}
            {% bootstrap_field sform.og_image layout="control" %}
            {% url "control:organizer.edit" organizer=request.organizer.slug as org_url %}
            {% propagated request.event org_url "primary_color" "primary_font" "theme_color_success" "theme_color_danger" %}
            {% bootstrap_field sform.primary_color layout="control" %}
            {% bootstrap_field sform.theme_color_success layout="control" %}
            {% bootstrap_field sform.theme_color_danger layout="control" %}
            {% bootstrap_field sform.theme_color_background layout="control" %}
            {% bootstrap_field sform.hover_button_color layout="control" %}
            {% bootstrap_field sform.theme_round_borders layout="control" %}
            {% bootstrap_field sform.primary_font layout="control" %}
            {% endpropagated %}
        </fieldset>
    </div>
    <div class="form-group submit-group">
        <button type="submit" class="btn btn-primary btn-save">
            {% trans "Save" %}
        </button>
    </div>

    {% comment %}
    <div class="modal popup-modal" id="alert-modal-enable-talk" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="modal-card">
                        <div class="modal-card-icon">
                            <i class="fa fa-cog big-rotating-icon"></i>
                        </div>
                        <div class="modal-card-content">
                            <h3>{% trans "Component not enabled!" %}</h3>
                            <p>{% trans "Do you want to enable the feature?" %}</p>
                            <div class="button-group">
                                <button class="btn btn-primary" name="enable_talk_system" value="enable">{% trans "Yes"
                                    %}</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Cancel"
                                    %}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal popup-modal" id="alert-modal-enable-video" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="modal-card">
                        <div class="modal-card-icon">
                            <i class="fa fa-cog big-rotating-icon"></i>
                        </div>
                        <div class="modal-card-content">
                            <h3>{% trans "Component not enabled!" %}</h3>
                            <p>{% trans "Do you want to enable the feature?" %}</p>
                            <div class="button-group">
                                <button class="btn btn-primary" name="enable_video_system" value="enable">{% trans "Yes"
                                    %}</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Cancel"
                                    %}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal popup-modal" id="alert-modal-disabled" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="modal-card">
                        <div class="modal-card-icon">
                            <i class="fa fa-cog big-rotating-icon"></i>
                        </div>
                        <div class="modal-card-content">
                            <h3>{% trans "Component is enabled!" %}</h3>
                            <p>{% trans "The feature cannot be disabled, but if you do not publish it, it will not show
                                up publicly." %}</p>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Ok"
                                %}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endcomment %}
</form>


<script src="{% static 'sortable/Sortable.min.js' %}"></script>
<script src="{% static 'eventyay-common/js/partner-settings.js' %}"></script>
<link rel="stylesheet" href="{% static 'eventyay-common/css/partner-settings.css' %}">

<script>
// Pass URLs and messages to the JavaScript via data attributes
document.addEventListener('DOMContentLoaded', function() {
    const sponsorGroupsList = document.getElementById('sponsor-groups-list');
    if (sponsorGroupsList) {
        sponsorGroupsList.dataset.reorderUrl = '{% url "eventyay_common:partner.group.reorder" organizer=request.organizer.slug event=request.event.slug %}';
        sponsorGroupsList.dataset.errorMessage = '{% trans "Failed to update group order. Please refresh and try again." %}';
    }
    
    const partnerContainers = document.querySelectorAll('.partner-inline-sortable');
    partnerContainers.forEach(container => {
        container.dataset.reorderUrl = '{% url "eventyay_common:partner.reorder" organizer=request.organizer.slug event=request.event.slug %}';
        container.dataset.errorMessage = '{% trans "An error occurred. Please refresh and try again." %}';
    });
});
</script>
{% endblock %}

