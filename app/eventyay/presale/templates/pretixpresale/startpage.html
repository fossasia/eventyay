{% load compress %}
{% load safelink %}
{% load i18n %}
{% load static %}
{% load eventurl %}
{% load statici18n %}
{% load presale_locale %}

<!DOCTYPE html>
<html lang="{{ html_locale }}"{% if rtl %} dir="rtl" class="rtl"{% endif %}>
    <head>
        <meta charset="utf-8">
        <title>{% trans "Start page" %} :: {{ site_name }}</title>
        <meta name="title" content="{% trans "Start page" %} {{ site_name }}">
        <meta name="description" content="{% trans "Browse live events on" %} {{ site_name }}">
        <meta name="application-name" content="{{ site_name }}">
        <meta name="generator" content="{{ site_name }}">
        {{ html_head|safe }}
        <meta name="robots" content="index, follow">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#2185d0">
        <meta name="HandheldFriendly" content="True"/>
        {% include "common/includes/favicon.html" %}

        <script src="{% static "jquery/js/jquery-3.7.1.min.js" %}"></script>

        {% compress css %}
            <link rel="stylesheet" type="text/x-scss" href="{% static "fontawesome/scss/font-awesome.scss" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "common/css/_reset.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "common/css/base.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "common/css/_variables.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "common/css/_fonts.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "common/css/_dropdown.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "common/css/_tooltip.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "common/css/_pretalx.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "common/css/_rtl.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "common/css/_stages.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "cfp/css/_layout.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "agenda/css/_agenda.css" %}" />
            <link rel="stylesheet" type="text/css" href="{% static "agenda/css/_speaker.css" %}" />
            <link rel="stylesheet" type="text/x-scss" href="{% static "pretixpresale/scss/startpage.scss" %}" />
        {% endcompress %}
        {% if css_file %}
            <link rel="stylesheet" type="text/css" href="{{ css_file }}" />
        {% endif %}
        {% compress js %}
            <script defer src="{% static 'common/js/base.js' %}"></script>
            <script defer src="{% static 'common/js/lightbox.js' %}"></script>
            <script defer src="{% static 'common/js/dropdown.js' %}"></script>
        {% endcompress %}
        {% if DEBUG %}
            <script type="text/javascript" src="{% url 'javascript-catalog' lang=request.LANGUAGE_CODE %}" async></script>
        {% else %}
            <script src="{% statici18n request.LANGUAGE_CODE %}" async></script>
        {% endif %}
    </head>
    <body class="startpage-body" data-datetimeformat="{{ js_datetime_format }}" data-dateformat="{{ js_date_format }}" data-datetimelocale="{{ js_locale }}">
        {{ base_path|json_script:"base_path" }}
        {{ html_page_header|safe }}

        <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
            <div class="navbar-header">
                <a class="navbar-brand" href="{% url "presale:index" %}">
                    <img src="{% static 'pretixbase/img/eventyay-icon.svg' %}" alt="{{ site_name }}" />
                    {{ site_name }}
                </a>
            </div>
            <ul class="nav navbar-nav navbar-top-links navbar-right flip">
                <li class="startpage-search-nav">
                    <div class="startpage-search" role="search">
                        <i class="fa fa-search" aria-hidden="true"></i>
                        <input
                            id="startpage-search-input"
                            type="search"
                            autocomplete="off"
                            placeholder="{% trans "Search events" %}"
                            aria-label="{% trans "Search events" %}"
                        />
                        <div class="startpage-search-results" id="startpage-search-results" role="listbox"></div>
                    </div>
                </li>
                {% include "common/fragment_language_switch.html" %}
                {% if request.user.is_authenticated %}
                    {% include "common/fragment_profile_dropdown.html" %}
                {% else %}
                    <li>
                        <a href="{% url "eventyay_common:auth.login" %}?next={{ request.get_full_path|urlencode }}">
                            <i class="fa fa-sign-in"></i> {% trans "Login" %}
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>

        <div id="top-bg" class="header startpage-header">
            {% if startpage_header_image_url %}
                <img src="{{ startpage_header_image_url }}" id="header-image" alt="{% trans "Start page header" %}">
            {% endif %}
            <div class="header-image-overlay"></div>
        </div>

        <div class="container presale-container" id="main-container">
            <header class="startpage-hero-header">
                <div class="event-hero startpage-hero">
                    <div class="event-hero-overlay">
                        <div class="event-brand">
                            <div class="event-hero-text">
                                <div class="event-title">
                                    {{ startpage_header_text }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="card" id="main-card">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
                <main>
                    <section class="startpage-events" aria-label="{% trans "Live events" %}">
                        <h2>{% trans "Live events" %}</h2>
                        <div class="startpage-event-list">
                            {% for event in events %}
                                {% eventurl event "presale:event.index" as event_url %}
                                {% abseventurl event "presale:event.index" as event_url_abs %}
                                {% with event.visible_logo_url|default:event.visible_header_image_url as event_image_url %}
                                <article
                                    class="startpage-event-card"
                                    data-event-name="{{ event.name|event_localize|escape }}"
                                    data-event-date="{{ event.get_date_range_display|escape }}"
                                    data-event-url="{{ event_url }}"
                                    data-event-image="{{ event_image_url|default:''|escape }}"
                                >
                                    <a class="startpage-event-media" href="{{ event_url }}">
                                        {% if event.visible_header_image_url %}
                                            <img src="{{ event.visible_header_image_url }}" alt="{{ event.name|event_localize }}">
                                        {% else %}
                                            <div class="startpage-event-media-placeholder">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                        {% endif %}
                                    </a>
                                    <div class="startpage-event-body">
                                        <h3 class="startpage-event-title">
                                            <a href="{{ event_url }}">{{ event.name|event_localize }}</a>
                                        </h3>
                                        <div class="startpage-event-meta">
                                            <span class="startpage-event-date">
                                                {{ event.get_date_range_display }}
                                            </span>
                                            {% if event.location %}
                                                <span class="startpage-event-location">
                                                    <i class="fa fa-map-marker"></i>
                                                    {{ event.location|event_localize }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="startpage-event-footer">
                                        <a class="btn btn-primary" href="{{ event_url }}">
                                            {% trans "View event" %}
                                        </a>
                                        {% if event.testmode %}
                                            <span class="startpage-testmode-badge" title="{% trans "Test mode enabled" %}">
                                                <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                                                {% trans "Test Mode" %}
                                            </span>
                                        {% endif %}
                                        <button class="startpage-event-share" type="button" data-url="{{ event_url_abs }}" aria-label="{% trans "Copy event link" %}" title="{% trans "Copy event link" %}">
                                            <i class="fa fa-share-alt"></i>
                                        </button>
                                    </div>
                                </article>
                                {% endwith %}
                            {% empty %}
                                <p class="startpage-empty">{% trans "No live events available yet." %}</p>
                            {% endfor %}
                        </div>
                    </section>
                </main>
            </div>
            <footer>
                {% include "common/powered_by.html" %}
                {% if footer_text %}
                    · {{ footer_text|safe }}
                {% endif %}
                {% for footer in footer_links %}
                    · <a href="{% safelink footer.url %}" target="_blank" rel="noopener">{{ footer.label }}</a>
                {% endfor %}
            </footer>
        </div>
        {% include "common/includes/modals.html" %}
        {{ html_foot|safe }}
        <script>
            (() => {
                const buttons = document.querySelectorAll('.startpage-event-share');
                if (!buttons.length) {
                    return;
                }

                const copyText = async (text) => {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(text);
                        return true;
                    }
                    const helper = document.createElement('textarea');
                    helper.value = text;
                    helper.setAttribute('readonly', '');
                    helper.style.position = 'absolute';
                    helper.style.left = '-9999px';
                    document.body.appendChild(helper);
                    helper.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(helper);
                    return successful;
                };

                buttons.forEach((button) => {
                    button.addEventListener('click', async () => {
                        const url = button.dataset.url;
                        if (!url) {
                            return;
                        }
                        try {
                            const ok = await copyText(url);
                            if (ok) {
                                button.classList.add('is-copied');
                                window.setTimeout(() => button.classList.remove('is-copied'), 1600);
                            }
                        } catch (error) {
                            console.error(error);
                        }
                    });
                });

                const searchInput = document.getElementById('startpage-search-input');
                const resultsContainer = document.getElementById('startpage-search-results');
                if (!searchInput || !resultsContainer) {
                    return;
                }

                const events = Array.from(document.querySelectorAll('.startpage-event-card')).map((card) => {
                    const link = card.querySelector('.startpage-event-title a');
                    const date = card.querySelector('.startpage-event-date');
                    const image = card.querySelector('.startpage-event-media img');
                    return {
                        name: (link ? link.textContent.trim() : '') || (card.dataset.eventName || ''),
                        date: date ? date.textContent.trim() : '',
                        url: (link ? link.href : '') || (card.dataset.eventUrl || ''),
                        image: (image ? image.src : '') || (card.dataset.eventImage || ''),
                    };
                });

                const renderResults = (items, query) => {
                    if (!query) {
                        resultsContainer.innerHTML = '';
                        resultsContainer.classList.remove('is-open');
                        return;
                    }
                    const limited = items.slice(0, 6);
                    resultsContainer.innerHTML = limited
                        .map(
                            (item) => `
                                <a class="startpage-search-item" href="${item.url}" role="option">
                                    ${
                                        item.image
                                            ? `<img src="${item.image}" alt="" aria-hidden="true" />`
                                            : `<span class="startpage-search-placeholder"><i class="fa fa-calendar"></i></span>`
                                    }
                                    <span class="startpage-search-text">
                                        <span class="startpage-search-title">${item.name}</span>
                                        <span class="startpage-search-date">${item.date}</span>
                                    </span>
                                </a>
                            `
                        )
                        .join('');
                    if (!limited.length) {
                        resultsContainer.innerHTML = `<div class="startpage-search-empty">{% trans "No matching events" %}</div>`;
                    }
                    resultsContainer.classList.add('is-open');
                };

                const filterEvents = (query) => {
                    const needle = query.trim().toLowerCase();
                    if (!needle) {
                        renderResults([], '');
                        return;
                    }
                    const matches = events.filter((eventItem) => eventItem.name.toLowerCase().includes(needle));
                    renderResults(matches, needle);
                };

                searchInput.addEventListener('input', (event) => {
                    filterEvents(event.target.value);
                });

                document.addEventListener('click', (event) => {
                    if (!event.target.closest('.startpage-search')) {
                        resultsContainer.classList.remove('is-open');
                    }
                });
            })();
        </script>
    </body>
</html>
