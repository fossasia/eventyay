{% extends "pretixcontrol/global_settings_base.html" %}
{% load i18n %}
{% load bootstrap3 %}
{% load getitem %}
{% load static %}

{% block custom_header %}
    <script type="text/javascript" src="{% static "move-email-elements/moveEmailElements.js" %}"></script>
{% endblock %}

{% block inner %}
    <form action="" method="post" class="form-horizontal" enctype="multipart/form-data">
        {% csrf_token %}
        {% bootstrap_form_errors form %}
        <ul class="nav nav-tabs" role="tablist">
            {% for group_key, group_label, field_names in form.field_groups %}
                <li role="presentation" class="{% if forloop.first %}active{% endif %}">
                    <a href="#tab{{ forloop.counter }}" aria-controls="tab{{ forloop.counter }}" role="tab" data-toggle="tab">
                        {{ group_label }}
                    </a>
                </li>
            {% endfor %}
        </ul>

        <div class="tab-content">
            {% for group_key, group_label, field_names in form.field_groups %}
                <div role="tabpanel" class="tab-pane {% if forloop.first %}active{% endif %}" id="tab{{ forloop.counter }}">
                    {% if group_key == "payment_gateways" %}
                        <fieldset class="payment-gateway-section">
                            <legend>{% translate "Stripe — Organizer Billing" %}</legend>
                            <p class="help-block">
                                {% translate "This configuration is used for organizer billing and platform fees." %}
                            </p>
                            
                            <div class="payment-subsection">
                                <h4>{% translate "Live Credentials" %}</h4>
                                {% for field_name in field_names %}
                                    {% if field_name == "payment_stripe_publishable_key" or field_name == "payment_stripe_secret_key" %}
                                        {% with form|getitem:field_name as field %}
                                            {% bootstrap_field field layout='control' %}
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <div class="payment-subsection">
                                <h4>{% translate "Test Credentials" %}</h4>
                                {% for field_name in field_names %}
                                    {% if field_name == "payment_stripe_test_publishable_key" or field_name == "payment_stripe_test_secret_key" %}
                                        {% with form|getitem:field_name as field %}
                                            {% bootstrap_field field layout='control' %}
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <div class="payment-subsection">
                                <h4>{% translate "Webhooks" %}</h4>
                                {% for field_name in field_names %}
                                    {% if field_name == "stripe_webhook_secret_key" %}
                                        {% with form|getitem:field_name as field %}
                                            {% bootstrap_field field layout='control' %}
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </fieldset>

                        <fieldset class="payment-gateway-section">
                            <legend>{% translate "Stripe — Ticket Payments" %}</legend>
                            <p class="help-block">
                                {% translate "This configuration is used for ticket payments via the Stripe plugin." %}
                            </p>

                            <div class="payment-subsection">
                                <h4>{% translate "Client Configuration" %}</h4>
                                {% for field_name in field_names %}
                                    {% if field_name == "payment_stripe_connect_client_id" %}
                                        {% with form|getitem:field_name as field %}
                                            {% bootstrap_field field layout='control' %}
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <div class="payment-subsection">
                                <h4>{% translate "Live Credentials" %}</h4>
                                {% for field_name in field_names %}
                                    {% if field_name == "payment_stripe_connect_publishable_key" or field_name == "payment_stripe_connect_secret_key" %}
                                        {% with form|getitem:field_name as field %}
                                            {% bootstrap_field field layout='control' %}
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <div class="payment-subsection">
                                <h4>{% translate "Test Credentials" %}</h4>
                                {% for field_name in field_names %}
                                    {% if field_name == "payment_stripe_connect_test_publishable_key" or field_name == "payment_stripe_connect_test_secret_key" %}
                                        {% with form|getitem:field_name as field %}
                                            {% bootstrap_field field layout='control' %}
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <div class="payment-subsection">
                                <h4>{% translate "App Fees" %}</h4>
                                <p class="help-block">
                                    {% translate "Configure the application fees charged on ticket payments." %}
                                </p>
                                {% for field_name in field_names %}
                                    {% if "payment_stripe_connect_app_fee" in field_name %}
                                        {% with form|getitem:field_name as field %}
                                            {% bootstrap_field field layout='control' %}
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </fieldset>

                        <fieldset class="payment-gateway-section">
                            <legend>{% translate "PayPal" %}</legend>
                            <p class="help-block">
                                {% translate "Configure PayPal payment processing." %}
                            </p>
                            {% for field_name in field_names %}
                                {% if "payment_paypal" in field_name %}
                                    {% with form|getitem:field_name as field %}
                                        {% bootstrap_field field layout='control' %}
                                    {% endwith %}
                                {% endif %}
                            {% endfor %}
                        </fieldset>
                    {% elif group_key == "billing_validation" %}
                        <fieldset>
                            <legend>{{ group_label }}</legend>
                            <div class="form-group">
                                <label class="col-md-3 control-label">
                                    <strong>{{ form.billing_validation.label }}</strong>
                                </label>
                                <div class="col-md-9">
                                    <div class="checkbox">
                                        <label>
                                            {{ form.billing_validation }} {% trans "Enable" %}
                                        </label>
                                    </div>
                                    {% if form.billing_validation.help_text %}
                                        <span class="help-block">{{ form.billing_validation.help_text }}</span>
                                    {% endif %}
                                    {% if form.billing_validation.errors %}
                                        <div class="help-block">{{ form.billing_validation.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </fieldset>
                    {% else %}
                        {% for field_name in field_names %}
                            {% with form|getitem:field_name as field %}
                                {% bootstrap_field field layout='control' %}
                            {% endwith %}
                        {% endfor %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <div class="form-group submit-group">
            <button type="submit" class="btn btn-primary btn-save">
                {% translate "Save" %}
            </button>
        </div>
    </form>
{% endblock %}
